<template>
    <article class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
        <!-- Header Section -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-12">
            <div class="lg:col-span-2">
                <h1 class="text-4xl font-bold text-gray-900 mb-4">
                    Complete Guide to Gutter Maintenance
                </h1>
                <p class="text-xl text-gray-600 leading-relaxed">
                    Regular gutter maintenance is crucial for protecting your home from water damage.
                    This guide will walk you through the essential steps to properly inspect, clean,
                    and maintain your home's gutter system.
                </p>
            </div>
            <div class="lg:col-span-1">
                <img src="/images/autumn-leaves-clogging-rain-gutter-260nw-1510057928.webp" alt="Gutter Maintenance"
                    class="rounded-lg shadow-lg w-full h-64 object-cover" />
            </div>
        </div>

        <!-- Steps Section -->
        <section class="space-y-12">
            <!-- Safety First -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div>
                    <h2 class="text-2xl font-semibold text-gray-900 mb-4">
                        1. Safety and Preparation
                    </h2>
                    <ul class="space-y-3 text-gray-600">
                        <li class="flex items-start">
                            <UIcon name="i-heroicons-check-circle" class="w-6 h-6 text-green-500 mr-2 flex-shrink-0" />
                            <span>Locate all gutters and identify safe ladder access points</span>
                        </li>
                        <li class="flex items-start">
                            <UIcon name="i-heroicons-check-circle" class="w-6 h-6 text-green-500 mr-2 flex-shrink-0" />
                            <span>Ensure ladder is on stable, level ground</span>
                        </li>
                        <li class="flex items-start">
                            <UIcon name="i-heroicons-check-circle" class="w-6 h-6 text-green-500 mr-2 flex-shrink-0" />
                            <span>Gather necessary tools: gutter scoop, leaf blower, bucket, gloves</span>
                        </li>
                    </ul>
                </div>
                <div>
                    <img src="/images/ladder-safety.webp" alt="Ladder Safety"
                        class="rounded-lg shadow-lg w-full h-64 object-cover" />
                </div>
            </div>

            <!-- Initial Inspection -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="md:order-2">
                    <h2 class="text-2xl font-semibold text-gray-900 mb-4">
                        2. Initial Inspection
                    </h2>
                    <ul class="space-y-3 text-gray-600">
                        <li class="flex items-start">
                            <UIcon name="i-heroicons-check-circle" class="w-6 h-6 text-green-500 mr-2 flex-shrink-0" />
                            <span>Check for signs of leaks and overflow</span>
                        </li>
                        <li class="flex items-start">
                            <UIcon name="i-heroicons-check-circle" class="w-6 h-6 text-green-500 mr-2 flex-shrink-0" />
                            <span>Verify proper gutter slope for drainage</span>
                        </li>
                        <li class="flex items-start">
                            <UIcon name="i-heroicons-check-circle" class="w-6 h-6 text-green-500 mr-2 flex-shrink-0" />
                            <span>Inspect roof valleys for debris accumulation</span>
                        </li>
                    </ul>
                </div>
                <div class="md:order-1">
                    <img src="/images/man-cleaning-gutters-16260041.webp" alt="Gutter Inspection"
                        class="rounded-lg shadow-lg w-full h-64 object-cover" />
                </div>
            </div>

            <!-- Cleaning Process -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div>
                    <h2 class="text-2xl font-semibold text-gray-900 mb-4">
                        3. Cleaning Process
                    </h2>
                    <ul class="space-y-3 text-gray-600">
                        <li class="flex items-start">
                            <UIcon name="i-heroicons-check-circle" class="w-6 h-6 text-green-500 mr-2 flex-shrink-0" />
                            <span>Start with second story gutters if applicable</span>
                        </li>
                        <li class="flex items-start">
                            <UIcon name="i-heroicons-check-circle" class="w-6 h-6 text-green-500 mr-2 flex-shrink-0" />
                            <span>Remove debris using gutter scoop or leaf blower</span>
                        </li>
                        <li class="flex items-start">
                            <UIcon name="i-heroicons-check-circle" class="w-6 h-6 text-green-500 mr-2 flex-shrink-0" />
                            <span>Clear roof valleys of organic debris</span>
                        </li>
                    </ul>
                </div>
                <div>
                    <img src="/images/gutter-maintenance.jpg" alt="Gutter Cleaning"
                        class="rounded-lg shadow-lg w-full h-64 object-cover" />
                </div>
            </div>

            <!-- Final Inspection -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="md:order-2">
                    <h2 class="text-2xl font-semibold text-gray-900 mb-4">
                        4. Final Inspection
                    </h2>
                    <ul class="space-y-3 text-gray-600">
                        <li class="flex items-start">
                            <UIcon name="i-heroicons-check-circle" class="w-6 h-6 text-green-500 mr-2 flex-shrink-0" />
                            <span>Check joints and corners for proper sealing</span>
                        </li>
                        <li class="flex items-start">
                            <UIcon name="i-heroicons-check-circle" class="w-6 h-6 text-green-500 mr-2 flex-shrink-0" />
                            <span>Verify gutter hangers are secure</span>
                        </li>
                        <li class="flex items-start">
                            <UIcon name="i-heroicons-check-circle" class="w-6 h-6 text-green-500 mr-2 flex-shrink-0" />
                            <span>Ensure downspouts are clear and properly diverting water</span>
                        </li>
                    </ul>
                </div>
                <div class="md:order-1 text-center">
                    <img src="/images/hands-worker-fixing-drain-scaffold-260nw-415177999.webp" alt="Gutter Inspection"
                        class="rounded-lg shadow-lg w-full h-64 object-cover" />
                </div>
            </div>
        </section>
        <section>
            <div class="md:col-span-2 mt-4">
                <button @click="isOpen = true" type="submit" class="bg-blue-500 text-white rounded p-2 w-full">
                    Log Project
                </button>
            </div>
        </section>
    </article>
    <UModal v-model="isOpen">
        <form @submit.prevent="submitForm" class="max-w-4xl mx-auto px-4">
            <UCard :ui="{ ring: '', divide: 'divide-y divide-gray-100 dark:divide-gray-800' }">
                <template #header>
                    <article>
                        <div>
                            <UCheckbox v-model="isAccepted" label="Complete"
                                help="I certify I have completed the task according to the instructions provided.">
                            </UCheckbox>
                        </div>
                    </article>
                </template>

                <div class="flex flex-col md:col-span-2">
                    <label for="files" class="mb-1">Upload Files:</label>
                    <input type="file" ref="fileInput" multiple @change="handleFileUpload" id="files"
                        class="border rounded p-2" />
                    <!-- Display uploaded files in a carousel -->
                    <div v-if="uploadedFiles.length > 0" class="mt-6">
                        <h3 class="text-xl font-semibold mb-4">Attachments</h3>
                        <UCarousel v-slot="{ item }" :items="uploadedFiles" indicators>
                            <video width="300" height="400" draggable="false" v-if="isVideo(item)" controls
                                class="rounded">
                                <source :src="item.preview" type="video/mp4" />
                                Your browser does not support the video tag.
                            </video>
                            <img width="300" height="400" draggable="false" v-else :src="item.preview" :alt="item.name"
                                class="rounded" />
                        </UCarousel>
                    </div>
                </div>
                <div class="md:col-span-2 mt-4">

                </div>
                <template #footer>

                    <div class="flex justify-center gap-4 w-full px-4">
                        <button type="submit" :disabled="!isAccepted"
                            class="flex-1 bg-blue-500 text-white rounded p-2 max-w-[200px] disabled:opacity-50 disabled:cursor-not-allowed">
                            Submit
                        </button>

                        <button @click="isOpen = false" class="flex-1 bg-red-500 text-white rounded p-2 max-w-[200px]">
                            Cancel
                        </button>
                    </div>
                </template>
            </UCard>
        </form>
    </UModal>
</template>

<script setup>

import { useRoute } from 'vue-router';
import { ref } from 'vue';
import { getDocument, GlobalWorkerOptions } from 'pdfjs-dist/legacy/build/pdf';
import { collection, addDoc, getDoc, doc, updateDoc, deleteDoc, serverTimestamp } from 'firebase/firestore'
import { ref as storageRef, uploadBytes, getDownloadURL } from 'firebase/storage';
const { $db, $storage } = useNuxtApp();
const route = useRoute();
const router = useRouter();
const homeId = route.params.homeId;

GlobalWorkerOptions.workerSrc = new URL(
    'pdfjs-dist/build/pdf.worker.mjs',
    import.meta.url
).toString();

const isOpen = ref(false)
const uploadedFiles = ref([]);
const fileInput = ref(null);
const isAccepted = ref(false);

const handleFileUpload = async (event) => {
    const files = Array.from(event.target.files);
    files.forEach((file) => {
        const reader = new FileReader();
        reader.onload = () => {
            if (file.type.startsWith('application/pdf')) {
                generatePdfThumbnail(file).then((thumbnail) => {
                    thumbnailBlob.value = thumbnail;
                    localThumbnailUrl.value = URL.createObjectURL(thumbnailBlob.value);
                    uploadedFiles.value.push({
                        name: file.name,
                        preview: localThumbnailUrl.value,
                        type: file.type,
                        file: file,
                        preview_file: thumbnail,
                    });
                });
            } else {
                uploadedFiles.value.push({
                    name: file.name,
                    preview: reader.result,
                    type: file.type,
                    file: file,
                    preview_file: null,
                });
            }
        };
        reader.readAsDataURL(file);
    });
};

const isImage = (file) => file.type.startsWith('image/');
const isVideo = (file) => file.type.startsWith('video/');
const isUploading = ref(false);
const localThumbnailUrl = ref(null);
const thumbnailBlob = ref(null);


async function generatePdfThumbnail(file) {
    const pdf = await getDocument(await file.arrayBuffer()).promise;
    const page = await pdf.getPage(1);
    const viewport = page.getViewport({ scale: 1 });
    const canvas = document.createElement('canvas');
    canvas.width = viewport.width;
    canvas.height = viewport.height;
    const context = canvas.getContext('2d');
    await page.render({ canvasContext: context, viewport }).promise;
    return new Promise((resolve) => {
        canvas.toBlob((blob) => {
            resolve(blob);
        }, 'image/png');
    });
}

const submitForm = async () => {
    isUploading.value = true;
    const user = await useCurrentUser()
    console.log(user.value)
    const updated_at_timestamp = serverTimestamp()
    const projectRecord = {
        type: "gutter_cleaning",
        timestamp: updated_at_timestamp,
        completedByUserUid: user.value.uid,
        completedByUserDisplayName: user.value.displayName,
        attachments: [],
    }

    const docRef = await addDoc(collection($db, "properties", homeId, "project_records"), projectRecord);
    console.log("Document written with ID: ", docRef.id);

    try {
        // Create an array of promises for file uploads
        const uploadPromises = uploadedFiles.value.map(async (file) => {
            const fileRef = storageRef($storage, `properties/${homeId}/project_records/${docRef.id}/${file.name}`);
            const snapshot = await uploadBytes(fileRef, file.file);
            const url = await getDownloadURL(fileRef);

            if (file.type.startsWith('application/pdf')) {
                const thumbnailRef = storageRef($storage, `properties/${homeId}/${file.name}-thumbnail.png`);
                const thumbnailSnapshot = await uploadBytes(thumbnailRef, file.preview_file);
                const thumbnailUrl = await getDownloadURL(thumbnailRef);
                console.log('Thumbnail uploaded:', thumbnailUrl);
                return {
                    name: file.name,
                    url: url,
                    type: file.type,
                    preview: thumbnailUrl,
                };
            }
            else {
                return {
                    name: file.name,
                    url: url,
                    type: file.type,
                    preview: url,
                };
            }
        });

        // Wait for all file uploads to complete
        const uploadedFileData = await Promise.all(uploadPromises);
        projectRecord.attachments = [...projectRecord.attachments, ...uploadedFileData];
        // const docRef = doc($db, "properties", homeId);
        await updateDoc(docRef, {
            attachments: {
                ...projectRecord.attachments
            },
        }, { merge: true });

    } catch (error) {
        console.error('Error in submitForm:', error);
    } finally {
        uploadedFiles.value = [];
        isUploading.value = false;

        // Clear the file input
        if (fileInput.value) {
            fileInput.value.value = '';
        }
        router.push({ name: 'homes-homeId', params: { homeId: homeId } })
    }
};



</script>